#include "surface.h"
#include "mesh.h"

#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <math.h>

static float grads[][3] = {
  {
    0.5416718730792324,
    0.8209693335149857,
    0.18055729102641088
  },
  {
    -0.15358394882501525,
    -0.8489030647229927,
    -0.5057425801405548
  },
  {
    0.5740719325325999,
    -0.5040327693334181,
    0.6452847307323888
  },
  {
    0.14095075243069152,
    0.7291915201134254,
    -0.6696361791181045
  },
  {
    0.8988914796715209,
    -0.16755360022655982,
    0.4048702246708958
  },
  {
    0.3261095765761692,
    0.9221317472098343,
    -0.20814798786692618
  },
  {
    0.4917016625376568,
    -0.3787615329485101,
    0.7840721753870614
  },
  {
    -0.10165524043927711,
    0.6394876658325922,
    -0.7620510070456018
  },
  {
    -0.6604283446498062,
    0.6886389548758343,
    -0.2993506161854954
  },
  {
    -0.5763443511294891,
    0.4211128527755858,
    0.7003507365230196
  },
  {
    0.26340726003044773,
    -0.37582940929896225,
    0.8884643326939159
  },
  {
    -0.23332410312511723,
    -0.8187542275582157,
    0.5245963951042832
  },
  {
    0.5864483306365353,
    0.7487254811272762,
    0.30901215090081796
  },
  {
    0.38086777548227113,
    0.9212355819238904,
    -0.0791501117910604
  },
  {
    0.45072446638546976,
    -0.8641448789727783,
    0.2238327133076304
  },
  {
    -0.2805257188392011,
    0.9489423451928392,
    0.1442697008025743
  },
  {
    0.8205525704404373,
    0.03693268152135386,
    -0.5703765915421439
  },
  {
    -0.011069011896917644,
    -0.5884255151142322,
    -0.8084756583461103
  },
  {
    -0.2701950221456542,
    0.22577623267805438,
    0.9359592634112953
  },
  {
    0.8437962019740027,
    -0.5099376481219065,
    -0.16724701660163177
  },
  {
    0.5430108200472756,
    -0.2969648261904987,
    0.7854623742212176
  },
  {
    -0.9568262384607108,
    -0.2859207903632521,
    -0.05227667769837842
  },
  {
    -0.33566713128762077,
    -0.7652147461813594,
    -0.5493395754901849
  },
  {
    -0.777642311448719,
    -0.5701283642386307,
    -0.2650020447756531
  },
  {
    -0.3322760838629237,
    -0.5001652010401013,
    -0.7996420297615893
  },
  {
    -0.10852692766465614,
    0.9379077817952197,
    -0.3294706342295791
  },
  {
    0.700300549380293,
    -0.2878338014510103,
    -0.6532463878812652
  },
  {
    0.8716156121059684,
    0.08044947898749384,
    0.4835432825133431
  },
  {
    -0.5857229481935314,
    -0.7512977412943042,
    0.3041057906149677
  },
  {
    -0.5912710108335142,
    0.7381037627682936,
    -0.32496373203051604
  },
  {
    -0.7081009172519469,
    0.4222493279553738,
    -0.5659492875056801
  },
  {
    0.5732493342780193,
    0.705973753374519,
    0.415916169793988
  },
  {
    0.20848860758249313,
    0.6347822769142627,
    0.7440322314415264
  },
  {
    -0.4351743772500551,
    -0.6173965579159698,
    -0.655320342777896
  },
  {
    0.5184749432445388,
    -0.7816859371766075,
    -0.34662779583856346
  },
  {
    0.8577420630388338,
    -0.050255291692504055,
    0.5116179814576367
  },
  {
    -0.12967095490943295,
    0.394696281176412,
    0.9096154622027851
  },
  {
    0.43169069951364775,
    0.6117171863703637,
    0.6629066479169923
  },
  {
    0.2409338220065283,
    -0.2390795647256685,
    -0.9406337518630253
  },
  {
    0.4252409188860303,
    -0.29596132182234397,
    -0.8553227793588429
  },
  {
    0.5483851387953962,
    0.7410250905085449,
    -0.38749910294755135
  },
  {
    0.46147831744844797,
    0.8866826587381988,
    -0.02883791285630678
  },
  {
    -0.15128397602202637,
    0.834120342272324,
    0.5304304037349933
  },
  {
    -0.7133246771866529,
    -0.41032870371317753,
    0.5681533770256239
  },
  {
    -0.5221226943405586,
    0.39152982108063317,
    0.7576887825876287
  },
  {
    0.22596002183615263,
    0.5588310608242213,
    -0.7979034490399705
  },
  {
    0.23026523021897857,
    -0.8517692796203848,
    -0.47060282409604326
  },
  {
    -0.7788821294913703,
    -0.09123689435307977,
    -0.620498555572689
  },
  {
    -0.7042201588285996,
    -0.5575006932438705,
    -0.43962136541804436
  },
  {
    -0.5168420485919137,
    0.6408912310479339,
    -0.5675673764172655
  },
  {
    0.7926059636439536,
    -0.4481082772206619,
    0.41349094099190375
  },
  {
    -0.021601859891203792,
    -0.4579546026472365,
    -0.8887130816880398
  },
  {
    0.8542209607932865,
    -0.06941333669218909,
    0.5152556053364693
  },
  {
    0.26355926344743036,
    -0.6180644821668938,
    -0.7406300092048779
  },
  {
    -0.2575924808652076,
    0.8164011470607183,
    0.5168513140929906
  },
  {
    0.4846032666848273,
    0.573205679370016,
    0.6607532996938816
  },
  {
    0.7944918091782632,
    0.41691810558939046,
    -0.44154508080195415
  },
  {
    0.5040374061744036,
    0.5462764500381945,
    -0.6689755849884563
  },
  {
    -0.1109379370749103,
    -0.7343974983784127,
    -0.6695917326947017
  },
  {
    -0.014982601326402473,
    -0.6506161962122997,
    -0.7592589063578593
  },
  {
    -0.4300679808342594,
    0.14067233043763003,
    0.891769492251439
  },
  {
    -0.28916442468124104,
    0.5285191673950774,
    -0.7981550132616977
  },
  {
    -0.6388833823017115,
    -0.2708206698686156,
    -0.7200584619255853
  },
  {
    0.9263728642554317,
    -0.30214883642996565,
    -0.22480969066124687
  }
};

#define GRAD_SIZE 64

float *noisexyz(float x, float y, float z) {
  int idx = (int)(3450.0*(x*475 + y*37.5 + z));
  idx *= (idx>0)*2-1;

  idx = idx & (GRAD_SIZE-1);
  
  return grads[idx];
}

float pnoise13(float u, float v, float w, float fu, float fv, float fz, float sz) {
    float *g1 = noisexyz(fu, fv, fz);
    float *g2 = noisexyz(fu, fv+sz, fz);
    float *g3 = noisexyz(fu+sz, fv+sz, fz);
    float *g4 = noisexyz(fu+sz, fv, fz);

    fz += sz;
    
    float *g5 = noisexyz(fu, fv, fz);
    float *g6 = noisexyz(fu, fv+sz, fz);
    float *g7 = noisexyz(fu+sz, fv+sz, fz);
    float *g8 = noisexyz(fu+sz, fv, fz);
    
    float vm1 = v-1.0, um1 = u-1.0, wm1 = w-1.0;
    
    float c1, c2, c3, c4, c5, c6, c7, c8;
    
    c1 =   u*g1[0] +   v*g1[1] + w*g1[2];
    c2 =   u*g2[0] + vm1*g2[1] + w*g2[2];
    c3 = um1*g3[0] + vm1*g3[1] + w*g3[2];
    c4 = um1*g4[0] +   v*g4[1] + w*g4[2];
    
    c5 =   u*g5[0] +   v*g5[1] + wm1*g5[2];
    c6 =   u*g6[0] + vm1*g6[1] + wm1*g6[2];
    c7 = um1*g7[0] + vm1*g7[1] + wm1*g7[2];
    c8 = um1*g8[0] +   v*g8[1] + wm1*g8[2];
    
    wm1 = w-1;
    um1=u-1;
    vm1=v-1;
    
    float wm12=wm1*wm1, w2=w*w, v2=v*v, u2=u*u, um12=um1*um1, vm12=vm1*vm1;
    
    return ((((2*w+1)*wm12*c3-(2*w-3)*c7*w2)*(2*v-3)*v2-((2*w+
      1)*wm12*c4-(2*w-3)*c8*w2)*(2*v+1)*(vm12))*(2*u-3)*u2
      +1+(((2*w+1)*wm12*c1-(2*w-3)*c5*w2)*(2*v+1)*vm12-((2
      *w+1)*wm12*c2-(2*w-3)*c6*w2)*(2*v-3)*v2)*(2*u+1)*um12)*0.5;
}

float pnoise13_dv(float dv[3], float u, float v, float w, float fu, float fv, float fz, float sz) {
    float *g1 = noisexyz(fu*sz, fv*sz, fz*sz);
    float *g2 = noisexyz(fu*sz, (fv+1.0)*sz, fz*sz);
    float *g3 = noisexyz((fu+1.0)*sz, (fv+1.0)*sz, fz*sz);
    float *g4 = noisexyz((fu+1.0)*sz, fv*sz, fz*sz);

    fz += 1.0;
    
    float *g5 = noisexyz(fu*sz, fv*sz, fz*sz);
    float *g6 = noisexyz(fu*sz, (fv+1.0)*sz, fz*sz);
    float *g7 = noisexyz((fu+1.0)*sz, (fv+1.0)*sz, fz*sz);
    float *g8 = noisexyz((fu+1.0)*sz, fv*sz, fz*sz);

    float u2=u*u, v2=v*v, w2=w*w;

    float ans3=-((g1[2]-g5[2]-(g5[2]-g6[2])*(2.0*v-3.0)*v2+(g1[2]-g2[2])*(2.0*v-3.0)*v2-(
            g5[2]-g8[2]+(g7[2]-g8[2])*(2.0*v-3.0)*v2+(g5[2]-g6[2])*(2.0*v-3.0)*v2)*(2.0*u-3.0)
            *u2+(g1[2]-g4[2]+(g3[2]-g4[2])*(2.0*v-3.0)*v2+(g1[2]-g2[2])*(2.0*v-3.0)*v2)*
            (2.0*u-3.0)*u2)*(2.0*w-3.0)*w2+(g1[2]-g4[2]+(g3[2]-g4[2])*(2.0*v-3.0)*v2+(
            g1[2]-g2[2])*(2.0*v-3.0)*v2)*(2.0*u-3.0)*u2+(g1[2]-g2[2])*(2.0*v-3.0)*v2+g1[2]
            );
    float ans2=6.0*(g5[0]*u+g5[1]*v-g1[2]*w-g1[1]*v-g1[0]*u+(w-1.0)*g5[2]+(g5[1]*v-g6[0]*u+
            g5[0]*u-(v-1.0)*g6[1]+(g5[2]-g6[2])*(w-1.0))*(2.0*v-3.0)*v2+(g2[0]*u+g2[2]*w-g1[2]
            *w-g1[1]*v-g1[0]*u+(v-1.0)*g2[1])*(2.0*v-3.0)*v2-((u-1.0)*g8[0]-g5[0]*u-(g5[2]-
            g8[2])*(w-1.0)-(g5[1]-g8[1])*v-((v-1.0)*g7[1]-g8[1]*v+(g7[2]-g8[2])*(w-1.0)+(g7[0]-
            g8[0])*(u-1.0))*(2.0*v-3.0)*v2-(g5[1]*v-g6[0]*u+g5[0]*u-(v-1.0)*g6[1]+(g5[2]-g6[2]
            )*(w-1.0))*(2.0*v-3.0)*v2)*(2.0*u-3.0)*u2+(g4[1]*v+g4[2]*w-g1[2]*w-g1[1]*v-
            g1[0]*u+(u-1.0)*g4[0]+(g4[1]*v+g4[2]*w-g3[2]*w-(v-1.0)*g3[1]-(g3[0]-g4[0])*(u-1.0))*
            (2.0*v-3.0)*v2+(g2[0]*u+g2[2]*w-g1[2]*w-g1[1]*v-g1[0]*u+(v-1.0)*g2[1])*(2.0*v-3.0)
            *v2)*(2.0*u-3.0)*u2)*(w-1.0)*w+ans3;
    float ans1=-ans2;
    dv[2] = ans1/2.0;
    
    ans3=6.0*(g2[0]*u+g2[2]*w-g1[2]*w-g1[1]*v-g1[0]*u+(v-1.0)*g2[1])*(v-1.0)*v-((g1[1]-
      g2[1])*(2.0*v-3.0)*v2+g1[1]);
      
    ans2=(6.0*(g2[0]*u+g2[2]*w-g1[2]*w-g1[1]*v-g1[0]*u+(v-1.0)*g2[1])*(v-1.0)*v+6.0*(
      g5[1]*v-g6[0]*u+g5[0]*u-(v-1.0)*g6[1]+(g5[2]-g6[2])*(w-1.0))*(v-1.0)*v-(g1[1]-g5[1]-
      (g5[1]-g6[1])*(2.0*v-3.0)*v2+(g1[1]-g2[1])*(2.0*v-3.0)*v2)+(6.0*((v-1.0)*g7[1]-
      g8[1]*v+(g7[2]-g8[2])*(w-1.0)+(g7[0]-g8[0])*(u-1.0))*(v-1.0)*v+g5[1]-g8[1]+(g7[1]-
      g8[1])*(2.0*v-3.0)*v2+(g5[1]-g6[1])*(2.0*v-3.0)*v2+6.0*(g5[1]*v-g6[0]*u+g5[0]*u-
      (v-1.0)*g6[1]+(g5[2]-g6[2])*(w-1.0))*(v-1.0)*v)*(2.0*u-3.0)*u2+(6.0*(g2[0]*u+g2[2]
      *w-g1[2]*w-g1[1]*v-g1[0]*u+(v-1.0)*g2[1])*(v-1.0)*v+6.0*(g4[1]*v+g4[2]*w-g3[2]*w-(
      v-1.0)*g3[1]-(g3[0]-g4[0])*(u-1.0))*(v-1.0)*v-(g1[1]-g4[1]+(g3[1]-g4[1])*(2.0*v-3.0)*v2
      +(g1[1]-g2[1])*(2.0*v-3.0)*v2))*(2.0*u-3.0)*u2)*(2.0*w-3.0)*w2+(6.0*(
      g2[0]*u+g2[2]*w-g1[2]*w-g1[1]*v-g1[0]*u+(v-1.0)*g2[1])*(v-1.0)*v+6.0*(g4[1]*v+g4[2]*
      w-g3[2]*w-(v-1.0)*g3[1]-(g3[0]-g4[0])*(u-1.0))*(v-1.0)*v-(g1[1]-g4[1]+(g3[1]-g4[1])*
      (2.0*v-3.0)*v2+(g1[1]-g2[1])*(2.0*v-3.0)*v2))*(2.0*u-3.0)*u2+ans3;
      
    ans1=-ans2;
  dv[1] = ans1/2.0;

  ans3=-((g1[0]-g4[0]+(g3[0]-g4[0])*(2.0*v-3.0)*v2+(g1[0]-g2[0])*(2.0*v-3.0)*v2)*
      (2.0*u-3.0)*u2+(g1[0]-g2[0])*(2.0*v-3.0)*v2+g1[0]);
      
  ans2=(6.0*(g4[1]*v+g4[2]*w-g1[2]*w-g1[1]*v-g1[0]*u+(u-1.0)*g4[0]+(g4[1]*v+g4[2]*w-
      g3[2]*w-(v-1.0)*g3[1]-(g3[0]-g4[0])*(u-1.0))*(2.0*v-3.0)*v2+(g2[0]*u+g2[2]*w-g1[2]
      *w-g1[1]*v-g1[0]*u+(v-1.0)*g2[1])*(2.0*v-3.0)*v2)*(u-1.0)*u-(6.0*((u-1.0)*g8[0]-
      g5[0]*u-(g5[2]-g8[2])*(w-1.0)-(g5[1]-g8[1])*v-((v-1.0)*g7[1]-g8[1]*v+(g7[2]-g8[2])*(
      w-1.0)+(g7[0]-g8[0])*(u-1.0))*(2.0*v-3.0)*v2-(g5[1]*v-g6[0]*u+g5[0]*u-(v-1.0)*
      g6[1]+(g5[2]-g6[2])*(w-1.0))*(2.0*v-3.0)*v2)*(u-1.0)*u+g1[0]-g5[0]-(g5[0]-g6[0])*(
      2.0*v-3.0)*v2+(g1[0]-g2[0])*(2.0*v-3.0)*v2-(g5[0]-g8[0]+(g7[0]-g8[0])*(2.0*v-3.0)*
      v2+(g5[0]-g6[0])*(2.0*v-3.0)*v2)*(2.0*u-3.0)*u2+(g1[0]-g4[0]+(g3[0]-g4[0])*(
      2.0*v-3.0)*v2+(g1[0]-g2[0])*(2.0*v-3.0)*v2)*(2.0*u-3.0)*u2))*(2.0*w-3.0)*w2
      +6.0*(g4[1]*v+g4[2]*w-g1[2]*w-g1[1]*v-g1[0]*u+(u-1.0)*g4[0]+(g4[1]*v+g4[2]*w-g3[2]*
      w-(v-1.0)*g3[1]-(g3[0]-g4[0])*(u-1.0))*(2.0*v-3.0)*v2+(g2[0]*u+g2[2]*w-g1[2]*w-
      g1[1]*v-g1[0]*u+(v-1.0)*g2[1])*(2.0*v-3.0)*v2)*(u-1.0)*u+ans3;
  ans1=-ans2;
  dv[0]=ans1/2.0;
}

void sm_perlin(StackMachine *sm) {
  float x = SPOP(sm);
  float y = SPOP(sm);
  float z = SPOP(sm);
  float sz=0.2, u = x/sz, v = y/sz, w=z/sz, fu=floor(u), fv=floor(v), fw=floor(w);
  float f;
  
  u -= fu; v -= fv; w -= fw;

  f = pnoise13(u, v, w, fu*sz, fv*sz, fw*sz, sz);
  
  SLOAD(sm, f);
}

void sm_perlin_dv(StackMachine *sm) {
  float x = SPOP(sm);
  float y = SPOP(sm);
  float z = SPOP(sm);
  float dx = SPOP(sm);
  float dy = SPOP(sm);
  float dz = SPOP(sm);
  float dv[3];
  
  float sz=0.2, u = x/sz, v = y/sz, w=z/sz, fu=floor(u), fv=floor(v), fw=floor(w);
  float f;
  
  u -= fu; v -= fv; w -= fw;

  pnoise13_dv(dv, u, v, w, fu*sz, fv*sz, fw*sz, sz);
  VECMULF(dv, 1.0/sz);
  
  f = dv[0]*dx + dv[1]*dy + dv[2]*dz;
  
  SLOAD(sm, f);
}
